using b8vB6mN3zAe.Database;
using b8vB6mN3zAe.Dtos;
using b8vB6mN3zAe.Mappers;
using b8vB6mN3zAe.Models;
using b8vB6mN3zAe.Tools;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace b8vB6mN3zAe.Controllers
{
    [Route("exploitation")]
    [ApiController]
    public class ExploitationController : ControllerBase
    {

        private readonly ApplicationDBContext _context;
        private readonly String _SECRETKEY;

        public ExploitationController(ApplicationDBContext context, IConfiguration configuration)
        {
            _context = context;
            _SECRETKEY = configuration["MySecretKey"];
        }


        [HttpGet]
        [Route("all")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitations()
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions)
                .ToListAsync();

                var accessibleExploitations = exploitations.Where(expl =>
                    Utils.UserHaveAccess(expl?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context)
                ).Select(explo => explo.ToExploitationResponseDto());

                return Ok(accessibleExploitations);

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }


        [HttpGet]
        [Route("land")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitationsByLand([FromHeader] string landID)
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions)
                .ToListAsync();

                var accessibleExploitations = exploitations.Where(expl =>
                    Utils.UserHaveAccess(expl?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context)
                    && expl.LandID ==landID
                ).Select(explo => explo.ToExploitationResponseDto());

                return Ok(accessibleExploitations);

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }


        [HttpGet]
        [Route("farmer")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitationsByFarmer([FromHeader] string farmerID)
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions)
                .ToListAsync();

                var accessibleExploitations = exploitations.Where(expl =>
                    Utils.UserHaveAccess(expl?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context)
                    && expl.Land.FarmerID == farmerID
                ).Select(explo => explo.ToExploitationResponseDto());

                return Ok(accessibleExploitations);

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }


        [HttpGet]
        [Route("zipCode")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitationsByZipCode([FromHeader] string zipCodeID)
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions)
                .ToListAsync();

                var accessibleExploitations = exploitations.Where(expl =>
                    Utils.UserHaveAccess(expl?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context)
                    && expl.Land.Farmer.ZipCodeID == zipCodeID	
                ).Select(explo => explo.ToExploitationResponseDto());

                return Ok(accessibleExploitations);

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }


        [HttpGet]
        [Route("city")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitationsByCity([FromHeader] int cityID)
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions)
                .ToListAsync();

                var accessibleExploitations = exploitations.Where(expl =>
                    Utils.UserHaveAccess(expl?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context)
                    && expl.Land.Farmer.ZipCode.CityID == cityID
                ).Select(explo => explo.ToExploitationResponseDto());

                return Ok(accessibleExploitations);

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }


        [HttpGet]
        [Route("sector")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitationsBySector([FromHeader] string sectorID)
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions)
                .ToListAsync();

                var accessibleExploitations = exploitations.Where(expl =>
                    Utils.UserHaveAccess(expl?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context)
                    && expl.Land.Farmer.ZipCode.City.SectorID == sectorID
                ).Select(explo => explo.ToExploitationResponseDto());

                return Ok(accessibleExploitations);

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }

        [HttpGet]
        [Route("id")]
        [Authorize(Roles = "Agronomist, Pedologist,  Admin")]
        public async Task<IActionResult> GetExploitationByID([FromHeader] String id)
        {
            try
            {
                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                var exploitations = await _context.Exploitations.
                Include(exploitations => exploitations.Land).
                ThenInclude(land => land.Farmer).
                ThenInclude(farmer => farmer.ZipCode).
                ThenInclude(zipCode => zipCode.City).
                ThenInclude(city => city.Sector).
                ThenInclude(sector => sector.Users).
                Include(exploitations => exploitations.Plots).
                ThenInclude(plot => plot.Positions).
                FirstOrDefaultAsync(exploitations => exploitations!.ID == id);

                if (exploitations is null)
                {
                    return NotFound("Exploitation Not found.");
                }

                if (!Utils.UserHaveAccess(exploitations?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context))
                {
                    return Unauthorized("Invalid access token.");
                }


                return Ok(exploitations.ToExploitationResponseDto());

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal Server error.");
            }
        }



        [HttpPost]
        [Authorize(Roles = "Agronomist, Pedologist")]
        public async Task<IActionResult> CreateExploitation(CreateExploitationRequest exploitationRequest)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest("Invalid request structure.");
                }
                //check request farmer if exist 
                var dbLand = await _context.Lands.FindAsync(exploitationRequest.LandID);
                if (dbLand is null)
                {
                    return NotFound("Selected Land not found.");
                }

                // Check if a land with the same name already exists
                var dbExploitation = await _context.Exploitations
                    .FirstOrDefaultAsync(exploitation => exploitation.Property == exploitationRequest.Property);


                Exploitation newExploitation = exploitationRequest.FromCreateExploitationRequestDto();
                //add land to db
                await _context.Exploitations.AddAsync(newExploitation);

                await _context.SaveChangesAsync();

                return Created();

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal server error.");
            }
        }


        [HttpPut]
        [Authorize(Roles = "Agronomist, Pedologist")]
        public async Task<IActionResult> UpdateExploitation(UpdateExploitationRequest exploitationRequest)
        {
            try
            {

                //decode token to get user id
                string accessToken = HttpContext.Request.Headers["Authorization"].ToString().Replace("Bearer ", "").Replace("bearer ", "");
                string accessUserId = Token.DecodeToken(accessToken, _SECRETKEY);

                if (!ModelState.IsValid)
                {
                    return BadRequest("Invalid request structure.");
                }

                var dbExploitation = await _context.Exploitations.FirstOrDefaultAsync(exploitation => exploitation.ID == exploitationRequest.ID);
                if (dbExploitation is null)
                {
                    return NotFound("Exploitation Not Found.");
                }

                //check request exploitation if exist 
                var dbLand = await _context.Exploitations.
                            Include(exploitations => exploitations.Land).
                            ThenInclude(land => land.Farmer).
                            ThenInclude(farmer => farmer.ZipCode).
                            ThenInclude(zipCode => zipCode.City).
                            ThenInclude(city => city.Sector).
                            ThenInclude(sector => sector.Users).
                            Include(exploitations => exploitations.Plots).
                            ThenInclude(plot => plot.Positions).
                            FirstOrDefaultAsync(exploitations => exploitations!.ID == exploitationRequest.ID);
                if (dbLand is null)
                {
                    return NotFound("Selected Land not found.");
                }

                if (!Utils.UserHaveAccess(dbExploitation?.Land?.Farmer?.ZipCode?.City?.Sector?.Users, accessUserId, _context))
                {
                    return Unauthorized("Invalid access token.");
                }


                //update the land
                dbExploitation.Property = exploitationRequest.Property;
                dbExploitation.Type = exploitationRequest.Type;
                dbExploitation.Diameter = exploitationRequest.Diameter;
                dbExploitation.LandID = exploitationRequest.LandID;


                await _context.SaveChangesAsync();

                return Ok("Exploitation Updated.");

            }
            catch (Exception)
            {
                return StatusCode(500, "Internal server error.");
            }
        }

    }


}